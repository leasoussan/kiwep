{% load i18n %}
{% load static %}

{% block css %}
    <link href="{% static "backend/css/project_mission_board.css" %}" rel="stylesheet" type="text/css">

    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js" type="text/javascript"></script>
    <script type="text/javascript">WebFont.load({ google: { families: ['Lato:100,100italic,300,300italic,400,400italic,700,700italic,900,900italic', 'Open Sans:300,300italic,400,400italic,600,600italic,700,700italic,800,800italic', 'Droid Sans:400,700', 'Varela Round:400'] } });</script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
{% endblock  %}


{% block content %}

    <div class="header-section">
        <a href="{% url 'create_chapter' project.pk %}" class="btn btn-success my-1">{% trans 'add_chapter' %}</a>
        <button class="btn btn-success my-1">{% trans 'add_mission' %}</button>
    </div>
    <div class="body-section">
        <div class="jobs-list-wrapper">
            <div class="jobs-list">
                <h2 class="jobs-list-heading">{% trans 'mission_without_chapter' %}</h2>
                <div class="jobs-list-body" id="new-jobs">
                    <ul id="new-jobs-list">
                        {% for mission in project.missions_without_chapters %}
                            {% include "backend/project/project_board/mission_block_from_board.html" %}
                        {% endfor %}
                    </ul>
                </div>
                <div class="jobs-list-footer"></div>
            </div>
            {% for chapter in project.chapter_set.all %}
                <div class="jobs-list">
                    <h2 class="jobs-list-heading">{{ chapter.name }}</h2>
                    <div class="jobs-list-body" id="{{chapter.id}}">
                        <ul id="{{chapter.id}}-list">
                            {% for mission in chapter.mission_set.all %}
                                {% include "backend/project/project_board/mission_block_from_board.html" %}
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="jobs-list-footer"></div>
                </div>
            {% endfor %}

        </div>
    </div>
{% endblock %}


{% block javascript %}
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        {#lea added this is it necessary TODO: check#}
        const csrftoken = getCookie('csrftoken');

        function extractMissionIdFromDivId(string){
            return string.match('(?<=^[^-]+-)[^-]+')

        }
        {##}
        {#function moveMissionToChapter(chapter_id, mission_id) {#}
        {#      url= '{% url "change_mission_chapter" %}';#}
        {#      fetch(url, {#}
        {#      method: "POST",#}
        {#      credentials: "same-origin",#}
        {#      headers: {#}
        {#        "X-Requested-With": "XMLHttpRequest",#}
        {#        "X-CSRFToken": getCookie("csrftoken"),#}
        {#      },#}
        {#      body: JSON.stringify({chapter_id: chapter_id, mission_id:mission_id})#}
        {#    });#}
        {#    }#}

        function moveMissionToChapter(chapter_id, mission_id, previous_id=null) {
            let url = '{% url "change_mission_chapter" %}';
            fetch(url, {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: JSON.stringify({chapter_id: chapter_id, mission_id:mission_id, previous_id:previous_id})
            });
        }

        function moveOrSortMission(ui, chapter_id){
            var string = ui.item[0].childNodes[1].id;
            console.log('hers',string)
            var result = string.match('(?<=^[^-]+-)[^-]+');
            if (ui.item[0].previousElementSibling){
                string = ui.item[0].previousElementSibling.childNodes[1].id;
                let previous_id = extractMissionIdFromDivId(string)[0];
                console.log('strings_previouse_id',string)
                moveMissionToChapter(chapter_id, result[0], previous_id);

            } else {
                moveMissionToChapter(chapter_id, result[0]);
            }
        }
        $( function() {
            $( "#new-jobs-list" ).sortable({
                connectWith: {{ project.chapter_html_ids|safe }},
                over: function( event, ui ) { //triggered when sortable element hovers sortable list
                    $('#new-jobs').css('background-color', 'rgba(0,0,0,.1)')
                },
                out: function( event, ui ) { //event is triggered when a sortable item is moved away from a sortable list.
                    $('#new-jobs').css('background-color', 'rgba(0,0,0,.0)')
                },
                receive: function( event, ui ) { // event is triggered when an item from a connected sortable list has been dropped into another list
                    $('#new-jobs').css('background-color', 'rgba(0,0,0,.0)');
                    let string = ui.item[0].childNodes[1].id;
                    let result = extractMissionIdFromDivId(string);
                    console.log('here_html_l_130',ui);
                    moveMissionToChapter(0, result[0])
                },
                revert: 100,
                start: function( event, ui ) { //event is triggered when sorting starts.

                },
                stop: function( event, ui ) { //event is triggered when sorting has stopped.

                }
            });
        });
        {% for chapter in project.chapter_set.all %}
            $( function() {
                $( "#{{chapter.id}}-list" ).sortable({
                    connectWith: {{ chapter.other_chapter_ids|safe }},
                    over: function( event, ui ) { //triggered when sortable element hovers sortable list
                        $('#{{chapter.id}}').css('background-color', 'rgba(0,0,0,.1)')
                    },
                    out: function( event, ui ) { //event is triggered when a sortable item is moved away from a sortable list.
                        $('#{{chapter.id}}').css('background-color', 'rgba(0,0,0,.0)')
                    },
                    receive: function( event, ui ) { // event is triggered when an item from a connected sortable list has been dropped into another list
                        $('#{{chapter.id}}').css('background-color', 'rgba(0,0,0,.0)');
                        let string = ui.item[0].childNodes[1].id;
                        let result = extractMissionIdFromDivId(string);
                        console.log('here_html_l_156',ui);

                        moveOrSortMission(ui, '{{ chapter.id }}')

                    },
                    revert: 100,
                    start: function( event, ui ) { //event is triggered when sorting starts.

                    },
                    stop: function( event, ui ) { //event is triggered when sorting has stopped.
                        $('#{{chapter.id}}').css('background-color', 'rgba(0,0,0,.0)');
                        moveOrSortMission(ui, '{{ chapter.id }}')
                    }
                });
            });
        {% endfor %}
    </script>
{% endblock %}
